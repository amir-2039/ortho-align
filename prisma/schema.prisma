// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  ADMIN
  EMPLOYEE
}

enum EmployeeType {
  DESIGNER
  QC
  BOTH
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CaseStatus {
  PENDING_PAYMENT
  PENDING_APPROVAL
  OPENED
  ASSIGNED
  IN_DESIGN
  PENDING_QC
  QC_REJECTED
  PENDING_CLIENT_REVIEW
  CLIENT_REJECTED
  APPROVED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum FileCategory {
  SCAN
  PHOTO
  XRAY
  PRODUCTION
  OTHER
}

enum AlignmentGoal {
  MAINTAIN
  IMPROVE
  IDEALIZE
}

enum ProcedureOption {
  YES
  NO
  ONLY_IF_NEEDED
}

enum MidlinePosition {
  CENTERED
  SHIFTED_RIGHT
  SHIFTED_LEFT
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  name         String
  role         UserRole
  employeeType EmployeeType?
  
  // Client-specific fields
  gender           Gender?
  region           String?
  phone            String?
  website          String?
  businessAddress  String?
  hearAboutUs      String?
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  createdPatients      Patient[]
  createdCases         Case[]              @relation("CaseCreator")
  assignedAsDesigner   Case[]              @relation("CaseDesigner")
  assignedAsQC         Case[]              @relation("CaseQC")
  designerAssignments  CaseAssignment[]    @relation("DesignerAssignment")
  qcAssignments        CaseAssignment[]    @relation("QCAssignment")
  adminAssignments     CaseAssignment[]    @relation("AdminAssignment")
  workflowLogs         CaseWorkflowLog[]
  comments             CaseComment[]
  productionUrls       CaseProductionUrl[]

  @@map("users")
}

model Patient {
  id          String   @id @default(cuid())
  name        String
  gender      Gender?
  dateOfBirth DateTime?
  address     String?
  notes       String?
  createdById String
  createdAt   DateTime @default(now())

  createdBy User   @relation(fields: [createdById], references: [id], onDelete: Cascade)
  cases     Case[]

  @@map("patients")
}

model Case {
  id              String     @id @default(cuid())
  patientId       String
  createdById     String
  status          CaseStatus @default(PENDING_PAYMENT)
  designerId      String?
  qcId            String?
  notes           String?
  refinementCount Int        @default(0)
  paymentProofUrl String?
  submittedAt     DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  patient        Patient              @relation(fields: [patientId], references: [id], onDelete: Cascade)
  createdBy      User                 @relation("CaseCreator", fields: [createdById], references: [id])
  designer       User?                @relation("CaseDesigner", fields: [designerId], references: [id])
  qc             User?                @relation("CaseQC", fields: [qcId], references: [id])
  assignments    CaseAssignment[]
  payments       Payment[]
  workflowLogs   CaseWorkflowLog[]
  files          CaseFile[]
  prescription   Prescription?
  comments       CaseComment[]
  productionUrls CaseProductionUrl[]

  @@index([patientId])
  @@index([createdById])
  @@index([designerId])
  @@index([qcId])
  @@index([status])
  @@index([createdAt])
  @@map("cases")
}

model CaseAssignment {
  id          String   @id @default(cuid())
  caseId      String
  designerId  String
  qcId        String
  assignedById String
  assignedAt  DateTime @default(now())

  case       Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  designer   User @relation("DesignerAssignment", fields: [designerId], references: [id])
  qc         User @relation("QCAssignment", fields: [qcId], references: [id])
  assignedBy User @relation("AdminAssignment", fields: [assignedById], references: [id])

  @@index([caseId])
  @@map("case_assignments")
}

model Payment {
  id         String        @id @default(cuid())
  caseId     String
  amount     Float
  status     PaymentStatus @default(PENDING)
  externalId String?
  paidAt     DateTime?
  createdAt  DateTime      @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@map("payments")
}

model CaseWorkflowLog {
  id           String      @id @default(cuid())
  caseId       String
  fromStatus   CaseStatus?
  toStatus     CaseStatus
  performedById String
  note         String?
  createdAt    DateTime    @default(now())

  case        Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  performedBy User @relation(fields: [performedById], references: [id])

  @@index([caseId])
  @@index([createdAt])
  @@map("case_workflow_logs")
}

model CaseFile {
  id          String       @id @default(cuid())
  caseId      String
  category    FileCategory
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  uploadedAt  DateTime     @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([category])
  @@map("case_files")
}

model Prescription {
  id     String @id @default(cuid())
  caseId String @unique
  
  // DURATION
  durationRecommended Boolean @default(true)
  durationLimitSteps  Int?
  
  // EXISTING CONDITION
  chiefComplaint      String
  
  upperMidlinePosition MidlinePosition @default(CENTERED)
  upperMidlineShiftMm  Float?
  
  lowerMidlinePosition MidlinePosition @default(CENTERED)
  lowerMidlineShiftMm  Float?
  
  canineRelationshipRight String?
  canineRelationshipLeft  String?
  
  molarRelationshipRight  String?
  molarRelationshipLeft   String?
  
  // INSTRUCTION - Treat Arches
  treatUpperArch Boolean @default(true)
  treatLowerArch Boolean @default(true)
  
  // INSTRUCTION - Alignment Goals
  upperMidlineGoal         AlignmentGoal @default(IMPROVE)
  lowerMidlineGoal         AlignmentGoal @default(IMPROVE)
  overjetGoal              AlignmentGoal @default(IMPROVE)
  overbiteGoal             AlignmentGoal @default(IMPROVE)
  archFormGoal             AlignmentGoal @default(IMPROVE)
  canineRelationshipGoal   AlignmentGoal @default(IMPROVE)
  molarRelationshipGoal    AlignmentGoal @default(MAINTAIN)
  posteriorRelationshipGoal AlignmentGoal @default(MAINTAIN)
  
  // INSTRUCTION - Procedures
  iprOption       ProcedureOption @default(ONLY_IF_NEEDED)
  engagersOption  ProcedureOption @default(ONLY_IF_NEEDED)
  proclineOption  ProcedureOption @default(ONLY_IF_NEEDED)
  expandOption    ProcedureOption @default(ONLY_IF_NEEDED)
  distalizeOption ProcedureOption @default(ONLY_IF_NEEDED)
  
  // INSTRUCTION - Tooth-Specific Selections (Universal Notation 1-32)
  avoidEngagersTeeth Json @default("[]")
  extractTeeth       Json @default("[]")
  leaveSpacesTeeth   Json @default("[]")
  doNotMoveTeeth     Json @default("[]")
  
  // RETAINER OPTION
  includeRetainer Boolean @default(true)
  
  // ADDITIONAL INSTRUCTIONS
  additionalInstructions String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  @@map("prescriptions")
}

model CaseComment {
  id        String   @id @default(cuid())
  caseId    String
  userId    String
  comment   String
  isInternal Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  case        Case                 @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user        User                 @relation(fields: [userId], references: [id])
  attachments CommentAttachment[]

  @@index([caseId])
  @@index([userId])
  @@index([createdAt])
  @@index([isInternal])
  @@map("case_comments")
}

model CommentAttachment {
  id        String   @id @default(cuid())
  commentId String
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  createdAt DateTime @default(now())

  comment CaseComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([commentId])
  @@map("comment_attachments")
}

model CaseProductionUrl {
  id          String   @id @default(cuid())
  caseId      String
  url         String
  description String?
  addedById   String
  createdAt   DateTime @default(now())

  case      Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  addedBy   User @relation(fields: [addedById], references: [id])

  @@index([caseId])
  @@map("case_production_urls")
}
